###### tags: `王道`

# 王道计算机-计算机网络

## 计算机网络

### 1. 计网体系结构

:::success
**网络分类**

1. 按分布范围分类
    - 广域网WAN：提供长距离通信，使用交换技术。
    - 局域网LAN：覆盖范围较小，通常使用广播技术。

2. 按传输技术分类
    - 广播式网络：所有联网计算机共享公共信道，一台计算机发送报文时所有其他计算机都会收听。==局域网通常是广播式网络！==
    - 点对点网络：物理线路连接计算机。如果两端未被直接连接，则通过中间结点（路由器等）进行接收，存储与转发直至目的节点。==广域网基本都是点对点网络！==
:::

**往返时延RTT：从发送端发送一个短分组到发送端接收到来自接收端的确认共经历的时延。**

---

### 2. 物理层

物理层设备：中继器，集线器

---

### 3. 数据链路层

#### 3.1 主要功能：将网络层的==分组==进行组帧，并有差错控制与流量控制。
    - 注：在TCP/IP模型中，流量控制被转移到了传输层！（也就是TCP）
    
#### 3.2 组帧！

组帧：将网络层发来的分组组合成帧进行传输。**目的是在出错时只重发出错的帧提高效率！**

- 注意！组帧需要加首加尾，原因：==在网络中帧是信息的最小传输单位，所以接收端必须要搞清楚这一帧的起始点！！！==

#### 3.3 差错控制

**3.3.1 检错编码**

:::info
**1. 奇偶校验码**
最基本的校验码，由n-1位信息和1位校验元组成。
- 奇校验码：码长为n的信息中，‘1’的个数为奇数；
- 偶校验码：码长为n的信息中，‘1’的个数为偶数；

> 注意！奇偶校验码并不能知道具体哪些位错了！！


**2. 循环冗余码CRC**
具有纠错功能！太复杂现在先不细说后面补上。
:::

**3.3.2 纠错编码**

- pass！

#### 3.4 流量控制与可靠传输机制

1. 停止-等待流量控制：发送方每发送一帧都要等待接收方的应答才发送下一帧。
2. 滑动窗口流量控制：SR和GBN！

#### 3.5 介质访问控制

**3.5.1 信道划分**

> 1. 频分复用FDM
> 2. 时分复用TDM
> 3. 波分复用WDM
> 4. 码分复用CDM

**3.5.2 随机访问**

:::success
**1. ALOHA - 发送数据不侦听信道**
1.1 纯ALOHA：发送数据时不检测，直接发送，若一段时间无确认则认为产生冲突，一段时间后再次发送。

1.2 时隙ALOHA：将时间划分为等长时隙，只有每个时隙开始时能发送一个帧。（避免发送数据的随意性从而减小冲突可能性与提高利用率）

**----------------------------------------------------------------------------------------------------**

**2. CSMA: 载波侦听多路访问 - 发送帧前先监听信道**

- 1-坚持CSMA：发送帧前一直监听信道直到空闲再发送。
- p-坚持CSMA：在CSMA监听到信道空闲时，以p的概率发送帧，1-p概率推延到下一个时隙。（目的：降低CSMA监听到空闲后多个结点同时发送帧而造成冲突的概率！）
- 0-非坚持CSMA：监听到信道忙，就放弃监听，等待随机时间后再监听。

**----------------------------------------------------------------------------------------------------**

**3. CSMA/CD: 载波侦听多路访问/冲突检测 - 边发边听以检测冲突**

工作流程：**先听后发，边听边发，冲突停发，随机重发。**

- 冲突停发后，采用二进制指数退避算法！

==二进制指数退避算法：==
1. 确定基本退避时间，一般为两倍的端到端传播时延 2t。
2. 根据重传次数k（k不超过10，即`k = min(10, k)`。 
3. 从离散的整数集合 (2^0, 2^1, ..., 2^k) 中随机取数r，重传间隔即 2tr!
4. 重传次数k = 16也无法重传成功时，认为网络太拥挤永远无法发出帧，向上层报错。

**----------------------------------------------------------------------------------------------------**

**4. CSMA/CA： 载波侦听多路访问/冲突回避 - 发前先发送一个request来宣示主权**

- 和CSMA/CD的不同： 
- 1.CA无法边发边听，所以采用的是冲突回避；而CD无法回避冲突，采用的是冲突检测！
- 2.CA常用于无线局域网网！

> 简单地说， CA采用的就是发送数据时先广播告知其他结点以避免冲突。
:::

**3.5.3 轮询访问：令牌传递**

思想：利用一个令牌(token)沿着总线在各个计算机间依次传递使用。

- 令牌：一个特殊的MAC控制帧，本身不包含信息，仅控制信道使用。


#### 3.6 数据链路层设备：交换机，网桥

交换机的自学习：

- 过滤：决定一个帧是丢弃还是发送到某个接口
- 转发：决定一个帧被发送到哪个接口
- 交换表实现交换机的过滤与转发。
- 实现：若收到帧后查找交换表找不到帧对应的MAC地址则对除接收结点外结点进行广播，然后只有对应结点会接收并将发送结点记入交换表！


> 局域网，广域网与因特网
> 广域网即，通过交换机互相连接的多个局域网所组建成的大局域网，它仍是一个网络。
> 因特网：多个网络之间的互联！


---


### 4. 网络层

#### 4.1 简介

网络层：向上只提供简单灵活的，无连接的，best-effort的数据报服务。
效果：简化网络核心，给网络边缘更大的自由度。

每个路由器只知道根据IP的下一跳地址，而非知道从源主机到目的主机的全地址！！！

#### 4.2 IPv4 (version 4)

:::success
IPv4 分组格式
IP分组： 头部（20B）+ 数据部分

具体：
1. 版本：IP协议版本，4或者6；
2. 首部长度：==4位字节==，最常用是首部长度20B；
3. 总长度：==首部+数据共16位字节==，故数据报最大长度为 2^16-1=65535B，而==以太网帧的最大传输单元MTU=1500B==，故在数据链路层封装成帧时需注意不超过MTU (首部如果是20B，那么有效数据长度就是单MTU为1480B!)；
4. 标识：16位，是一个计数器，每产生一个数据报就加1；**标识不是序列号！因为IP是无连接的服务！** 它用于组装分组。
5. 标志：3位，表示该分组后还有没有分片；MF=1就是有分片，MF(More Fragment)=0就表示这是最后一个分片；只有DF(Dont Frangment)=0才允许分片；
6. 片偏移：13位，指出某片在原分组的相对位置，==单位为8Bit！==；
7. 生存时间TTL：8位。表示该数据报在网络中可通过的最大路由器数量，TTL被减为0则丢弃；
8. 协议：8位，指出使用的协议。**UDP:17,TCP:6**.
9. 首部校验和：16位，只校验分组首部而不校验数据部分。
10. 源地址&目的地址：各4字节.


![](https://i.imgur.com/kV03IPa.png)

:::

:::info
**网络地址转换NAT**：转换专用网络地址为公用地址，从而对外隐藏内部管理的IP.

NAT的问题：作为网络层的协议，转发数据时却需要查看和转换传输层的IP地址和端口号，很明显不符合网络模型的规范！
:::

:::danger
==子网划分与CIDR==

1. 子网划分

> 普通的有类IP地址（**两级IP：网络号，主机号**）有时候利用率很低，且固定网络号长度不够灵活！

- 子网划分：**三级IP：（网络号， 子网号， 主机号）**, 路由器接收到IP数据报时，按网络号和子网号找到目的子网，再交付给目的主机。

> ==注意：划分子网只是在两级IP基础上对主机号这部分再进行划分，而不改变IP地址原本网络号！因此，从IP地址或者IP数据报首部无法判断源或者目的是否进行了子网划分！==

==**注： 所有形如127.xx.xx.xx都是保留地址，用于回路测试！**==

*---------------------------------------------------------------------------------------------------

2. 子网掩码：表达划分IP地址对应原网络的主机号的手段

子网掩码同IP地址，长32Bit，由一串1后跟随一串0组成。 1对应IP的网络与子网号，0对应主机号。计算时候只需对本身IP地址与对应子网掩码使用 `&&(and)` 运算即可得到对应子网的网络地址。

*---------------------------------------------------------------------------------------------------

3. 无分类编址CIDR：消除网络号改使用网络前缀！

CIDR取消了有类网络地址概念，而是取用前些位作为网络前缀，后面的作为主机号。虽然CIDR不使用子网，但仍有“掩码”概念。

> 网络前缀都相同的连续IP地址称为==CIDR地址块， 这样一个地址块可以表示很多地址，故又称路由聚合！==

- 优点：网络前缀长度有很高灵活性，可以控制前缀长度从而简化路由表；也可以延长网络前缀来灵活划分子网。

==CIDR路由表通常使用二叉树进行存储以更好实现最长前缀匹配！==
:::

#### 4.3 ARP, DHCP与ICMP

1. ARP：地址解析协议

> 无论网络层使用什么协议，在实际上的数据链路中传送数据帧的时候，最终都是使用MAC地址进行的；
> 所以，一种将IP映射到MAC的方法是必要的，也就是ARP.
> 每台主机都设置有ARP，用来存放本局域网各主机和路由器的IP->MAC映射表即ARP表。

```
ARP工作在网络层。
A欲向B发送数据报时，先在ARP表查看有无B的IP.
 - 有，则查出MAC地址，并将地址写入MAC帧，再送到数据链路层发送。
 - 无，则广播ARP请求分组，在B收到广播之后再向A单播发送包含B的IP->MAC的相应分组。
```

- ARP由于看到了IP地址，故工作在网络层；NAT由于看到了端口，故工作在传输层！

*---------------------------------------------------------------------------------------------------

2. DHCP：动态主机配置协议：给主机动态地分配IP!

- ==DHCP是应用层协议，它是基于UDP的！==
- 1. 为什么是应用层协议：因为它是通过服务器/客户端模式工作的！
- 2. 为什么基于UDP：连对方的IP都不知怎么可能建立连接使用TCP！

*---------------------------------------------------------------------------------------------------

3. ICMP：网际控制报文协议：报告差错与异常情况

注意点：
1. 对于已经携带ICMP差错报文的分组，不再产生ICMP差错报文（只有分组的第一个分片发！）
2. ICMP是纯纯的网络层协议！！！不管别的层的任何东西。
3. ICMP报文本身出错是不再处理的。


#### 4.4 IPv6

IPv6：根源上解决了IPv4地址耗尽的问题，毕竟IP长度从32位变成了128位（16*8）。IPv4（4B）：IPv6(16B)！

- 注：IPv6首部长度必须为8B的倍数且==是不可变的==，而IPv4是4B的倍数且==是可变的==。 
- **相比IPv4,IPv6增加了关键的身份验证和保密功能！且为了效率不再提供校验和字段！**
- ==**IPv6一般意义来说不允许分片！！！因为它只在包的源节点分片，在路由器是不分片的！！！**==


#### 4.5 IP组播

组播：将报文同时发往多个接收者，它是==仅用于UDP==的： 因为TCP需要两台主机的对应端口，是一一对应的！

组播的过程：源主机发送单个分组到组播地址 -> 网络将该分组的副本投递给组中的每一台主机。

> 由于组播基于UDP，它也只是best-effort而非可靠性交付！
> 组播数据报不会产生ICMP差错报文！

#### 4.6 网络层设备

冲突域：连接到同一物理介质上所有结点的集合，它们存在结点争用现象。
广播域：接收同样广播消息的结点集合。==路由器可以划分广播域，同一个路由器内的域（局域）就是进行的广播==

:::success

路由器：多输入/输出端口，任务是连接多个异构网络并依据路由表完成路由转发。

转发表：带有分组的目的地址，以及下一跳地址

注：路由器是网络层设备，且在路由器上实现了物理层，数据链路层以及网络层功能，所以路由器的传输延迟最长！


```
在一个互联网中，能不能使用一个很大的交换机去代替路由器？？

答：

不能！交换机和路由器的功能是不同的。
交换机可在单个网络中与若干计算机相连，并将一台计算机发来的帧转发给另一台计算机。
路由器连接复数个异构网络，在网络间转发分组。

因此，如果多个同构网络互联时，可以用一个很大的交换机去代替原来的路由器，但如果网络是异构的那么就必须用路由器互联。
```
:::

---

### 5. 传输层

#### 5.1 传输层提供的服务

传输层提供的是
1. 不同主机上的进程间的通信（端到端通信）；网络层提供的是主机之间的逻辑通信。
2. 复用和分用。 复用：发送方的不同进程都可以使用同一个传输层协议传输； 分用：接收方传输层剥去报文首部后能正确交付给进程。
3. 差错检测：包括首部和数据部分。网络层的差错检测值检查IP数据报首部。
4. 提供TCP和UDP协议。

:::success
**端口号和套接字**

**传输层通过套接字识别端口号来进行不同进程的复用分用。**

> 套接字，实际上是一个通信端点, 它唯一标识网络中的一台主机及其上的一个应用！
套接字Socket = （IP地址: 端口号）
:::

#### 5.2 无连接服务：UDP

UDP：在IP的数据报服务基础上增加：1. 复用分用；2. 差错检测

UDP优势：
1. 无连接服务，没有建立连接的时延；
2. 分组首部开销小， TCP20B, UDP8B；
3. UDP没有流量控制所以应用层能更好控制发送数据与时间；
4. UDP可以一对一，一对多和多对多；TCP只能一对一。


:::success
UDP首部格式：

![](https://i.imgur.com/JXHgSSZ.png)

1. 源端口：**在需要对方回信时选用**，不需要回信则全选0!
2. 目的端口：必须使用。
3. 长度：UDP数据报长度（包括首部和数据），在仅有首部是长度则是8.
4. 校验和：检测UDP数据报传输中是否出错，出错则丢弃。校验和的校错能力一般，但简单且处理速度快。
:::


#### 5.3 面向连接服务：TCP

相较于UDP，TCP是端到端的，这也注定TCP是一对一基础的可靠传输。此外：TCP提供全双工通信，允许通信双方随时发送数据。

:::info
**TCP报文段**

![](https://i.imgur.com/Bpz3iOp.png)

![](https://i.imgur.com/4Nffxmt.png)
![](https://i.imgur.com/CYNfWDX.png)

:::


:::success
**TCP连接管理**

1. **三次握手**：

```
步骤：
1. 客户端发送连接请求报文段，此报文段首部同步位 syn=1, 且选择初始序列号x, 该报文不携带数据。

2. 服务器收到报文，同意连接，向客户端发送确认报文。
报文段中，syn = ACK = 1，确认号 ack = x+1, 且服务器选择初始序列号 seq=y, 该报文不携带数据。

3. 客户收到报文段后，再向服务端发送确认报文。
报文段中，确认号 ack = y+1, 序号 seq=x+1, 且这次报文可以携带数据（若不携带数据则不消耗序号）。

至此，双方建立TCP连接。
```
![](https://i.imgur.com/xv4gAab.png)
![](https://i.imgur.com/OM7RjJO.png)

- 值得注意的是，服务器资源是在第二次握手时分配的，而客户端资源在第三次握手分配，这就使得服务器易受SYN flood攻击。

+---------------------------------------------------------------------------------------------

2. **四次挥手：**

![](https://i.imgur.com/KhtTtbX.png)

- ==注意点：关于连接和释放连接，所有的SYN, ACK, FIN一定等于1！==

![](https://i.imgur.com/OthdKIm.png)
![](https://i.imgur.com/jNiTelZ.png)

:::


#### 5.4 TCP控制

:::success
**可靠传输**：类似GBN+SR的滑动窗口机制！使用类GBN的累计确认！

**流量控制**：一种速度匹配服务，匹配发送方的发送速率与接收方的读取速率。

```
传输层和数据链路层的流量控制有什么不同？？

传输层：负责端到端的，窗口大小可动态变化

数据链路层：负责网络核心中相邻结点的，窗口大小不可动态变化
```

==拥堵控制：慢启动+加性增乘性减==

![](https://i.imgur.com/ipXiSUK.png)

:::

---

### 6. 应用层

- C/S:连接建立后，服务器可以主动发送数据给客户端。服务器面向任务，客户端面向用户。服务器地址不变！
- P2P:对等方式交换信息，没有地址不变的服务器。

#### 6.1 域名系统DNS

![](https://i.imgur.com/nbHEcI8.png)
- 因特网采用树状结构进行命名。不同的域名根据不同的域名服务器查询！

> 域名的解析：递归与迭代（见下图）
![](https://i.imgur.com/pavARVP.png)
>
> 递归：客户端只需进行一次解析；迭代：客户端需要解析多次。

#### 6.2 应用

:::success

- 文件传输协议FTP：采用C/S模式与TCP可靠传输服务。==对应端口为20==.
- 电子邮件SMTP：采用C/S模式与TCP可靠传输服务。==对应端口为25==.

- 万维网WWW:
> 构成： 
> 1. 统一资源定位符URL； 2. 超文本传输协议HTTP（端口80）； 3. 超文本标记语言HTML。
```
URL的形式： <协议>://<主机>：<端口>/<路径>

其中端口和路径经常省略（这就是我们平常看见的网址了）
```

:::